# HTTP

HTTP 正式作为标准被公布是在 1996 年的 5 月，版本被命名为 HTTP/1.0，1997 年 1 月公布的 HTTP/1.1 是目前主流的 HTTP 协议版本。

## 网络基础 TCP/IP

### TCP/IP 协议族

TCP/IP 协议族按层次分从下到上分别是：

- 数据链路层，用来处理连接网络的硬件部分。
- 网络层，用来处理在网络上流动的数据包。
- 传输层，提供处于网络连接中的两台计算机之间的数据传输。有 TCP 和 UDP 两个性质不同的协议。
- 应用层，决定了向用户提供应用服务时通信的活动，比如，FTP，DNS，HTTP。

### 负责传输的 IP 协议

IP （Internet Protocol）网际协议位于网络层。IP 协议的作用是把各种数据包传送给对方。其中有两个重要的条件是 IP 地址和 MAC 地址。IP 地址可变换，但 MAC 地址基本上不会更改。IP 通过 ARP 地址解析协议凭借 MAC 地址进行通信。

### 确保可靠性的 TCP 协议

为了准确无误地将数据送达目标处，TCP 协议采用了三次握手策略。

- 首先发送端发送一个带 SYN 标志的数据包给对方；
- 接收端收到后，回传一个带有 SYN+ACK 标志的数据包以示传达确认信息；
- 最后，发送端再传回传一个带 ACK 标志的数据包，代表握手结束。

### 负责域名解析的 DNS 服务

计算机既可以被赋予 IP 地址，也可以被赋予主机名和域名。比如 www.baidu.com， 用户通常使用主机名或域名来访问对方的计算机，而不是直接通过 IP 地址访问。所以 DNS 服务应运而生，它 提供通过域名查找 IP 地址，或逆向从 IP 地址反查域名的服务。

## 简单的 HTTP 协议

HTTP 是一种无状态协议，对于发送过的请求或响应都不做持久化处理。但为了实现期望的保持状态功能，于是引入了 Cookie 技术。

### 请求报文

请求报文由以下几个部分构成：

- 请求方法
- 请求 URI
- 协议版本
- 可选的请求首部字段
- 内容实体

```

POST /index.html HTTP/1.1

Host: baidu.com
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 16

name=hhh&age=18
```

### 响应报文

响应报文由以下几个部分构成：

- 协议版本
- 状态码
- 用以解释状态码原因的短语
- 可选的响应首部字段
- 实体主体

```

HTTP/1.1 200 ok

Date: Tue, 10 Jul 2012 06:50:15 GMT
Content-Length: 362
Content-Type: text/html

<html>
...
```

### HTTP/1.1 请求方法

- GET：获取资源
- POST：传输实体主体
- PUT：传输文件
- HEAD：获得报文首部
- DELETE：删除文件
- OPTIONS：询问支持的方法
- TRACE：追踪路径
- CONNECT：要求用隧道协议连接代理

|  方法   | 支持的 HTTP 协议版本 |
| :-----: | :------------------: |
|   GET   |       1.0、1.1       |
|  POST   |       1.0、1.1       |
|   PUT   |       1.0、1.1       |
|  HEAD   |       1.0、1.1       |
| DELETE  |       1.0、1.1       |
| OPTIONS |         1.1          |
|  TRACE  |         1.1          |
| CONNECT |         1.1          |
|  LINK   |         1.0          |
| UNLINK  |         1.0          |

### 使用 Cookie 状态管理

Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。根据从服务端发送的响应报文内的一个叫做 Set-Cookie 的首部字段信息，通知客户端保存 Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值发送出去。

### Session 和 Cookie 区别

Session 是服务器用来跟踪用户的一种手段，每个 Session 都有一个唯一标识：Session ID。当服务器创建了一个 Session 时，给客户端发送的响应报文包含了 Set-Cookie 字段，其中有一个名为 sid 的键值对，这个键值对就是 Session ID。客户端收到后就把 Cookie 保存在浏览器中，并且之后发送的请求报文都包含 Session ID。HTTP 就是通过 Session 和 Cookie 这两种方式一起合作来实现跟踪用户状态的，Session 用于服务器端，Cookie 用于客户端。

### 获取部分内容的范围请求

如果下载过程中遇到网络中断的情况，那就必须重头开始。为了解决上诉问题，需要一种可恢复的机制。要实现该功能需要指定下载的实体范围。执行范围请求时，会用到首部字段 Range 来指定资源的 byte 范围。

### 内容协商返回最合适的内容

内容协商机制是指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户端最为合适的资源。内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。内容协商技术有以下类型：

- 服务器驱动协商
- 客户端驱动协商
- 透明协商

## HTTP 状态码

|          状态码           |                             解释                             |
| :-----------------------: | :----------------------------------------------------------: |
|          200 OK           |           从客户端发来的请求在服务器端被正常处理了           |
|      204 No Content       |                 请求处理成功，但没有资源返回                 |
|    206 Partial Content    |                     客户端进行了范围请求                     |
|   301 Moved Permanently   |         请求的资源被分配了新的 URI，以后使用新的 URI         |
|         302 Found         |     请求的资源被分配了新的 URI，希望用户本次使用新的 URI     |
|       303 See Other       |     请求的资源存在着另一个 URI，应使用 GET 方法定向获取      |
|     304 Not Modified      | 客户端发送附带条件请求时，服务器端允许请求服务资源，但请求未满足条件的情况时，服务器端资源未改变，可直接使用客户端未过期的缓存 |
|  307 Temporary Redirect   | 与 302 Found 有着相同的含义，307 会遵照浏览器标准，不会从 POST 变成 GET。 |
|      400 Bad Request      |                    请求报文中存在语法错误                    |
|     401 Unauthorized      |                发送的请求需要有通过 HTTP 认证                |
|       403 Forbidden       |                 请求资源的访问被服务器拒绝了                 |
|       404 Not Found       |                      无法找到请求的资源                      |
| 500 Internal Server Error |                 服务端在执行请求时发生了错误                 |
|  503 Service Unavailable  |            服务器暂时处于超负载或正在进行停机维护            |

## 通信数据转发程序

### 代理

接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。

利用缓存代理减少网络带宽的流量，组织内部针对特定网站的访问控制，以获取访问日志等等。

### 网关

网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，就像自己拥有资源的源服务器一样对请求进行处理。网关能使通信线路上的服务器提供非 HTTP 协议服务。

### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序，它本身不会去解析 HTTP 请求。隧道的目的是确保客户端能与服务器进行安全的通信。

## 基于 HTTP 的功能追加协议

### HTTP 的瓶颈

- 一条连接上只可发送一个请求
- 请求只能从客户端开始，客户端不可以接收除响应以外的指令。
- 请求/响应首部未经压缩就发送。首部信息越多延迟越大。
- 发送冗长的首部。每次互相发送相同的首部造成的浪费较多。
- 可任意选择数据压缩格式。非强制压缩发送。

### Ajax 的解决方法

它是一种有效利用 JavaScript 和 DOM 的操作，以达到局部 Web 页面替换加载的异步通信手段。借用这种手段，就能从已加载完毕的 Web 页面上发送请求，只更新局部页面。

利用 Ajax 实时地从服务器获取内容，有可能会导致大量请求产生。

### Comet 的解决方法

一旦服务器端有内容更新了，Comet 不会让请求等待，而是直接给客户端返回响应。为了实现推送功能，Comet 会将响应置于挂起状态，当服务器端有内容更新时，再返回响应。

为了维持连接会消耗更多的资源。

### SPDY 的设计与功能

SPDY 以会话层的形式加入，控制对数据的流动。规定通信中使用 SSL，还是采用 HTTP 建立通信连接。

使用 SPDY 后，HTTP 协议额外获得以下功能：

- 多路复用流

  通过单一的 TCP 连接，可以无限制处理多个 HTTP 请求。

- 赋予请求优先级

  给请求逐个分配优先级顺序，解决因宽带低而导致响应变慢的问题。

- 压缩 HTTP 首部

  这样一来，通信产生的数据包数量和发送的字节数就更少了。

- 推送功能

  支持服务器主动向客户端推送数据的功能。

- 服务器提示功能

  服务器可以主动提示客户端请求所需的资源。

### 全双工通信的 WebSocket

一旦 Web 服务器与客户端之间建立起 WebSocket 协议的通信连接，之后所有的通信都依靠这个专用协议进行。通信过程中可互相发送 JSON、XML、HTML 或图片等任意格式的数据。

WebSocket 协议的主要特点：

- 推送功能
- 减少通信量
- 握手请求
- 握手响应

## Web 的攻击技术

### 因输出值转义不完全引发的安全漏洞

- #### 跨站脚本攻击

  通过存在安全漏洞的 Web 网站注册用户的浏览器内运行非法的 HTML 标签或 JavaScript 进行的一种攻击。

- #### SQL 注入攻击

  针对 Web 应用使用的数据库，通过运行非法的 SQL 而产生的攻击。

- #### OS 命令注入攻击

  通过 Web 应用，执行非法的操作系统命令达到攻击的目的。只要在能调用 Shell 函数的地方就有存在被攻击的风险。

- #### HTTP 首部注入攻击

  攻击者通过在响应首部字段内插入换行，添加任意响应首部或主体的一种攻击。

- #### 邮件首部注入攻击

  指 Web 应用中的邮件发送功能，攻击者通过向邮件首部 To 或 Subject 内任意添加非法内容发起的攻击。

- #### 目录遍历攻击

  对本无意公开的文件目录，通过非法截断其目录路径后，达成访问目的的一种攻击。

- #### 远程文件包含漏洞

  指当部分脚本内容需要从其他文件读入时，攻击者利用指定外部服务器的 URL 充当依赖文件，让脚本读取之后，就可以运行任意脚本的一种攻击。

### 因设置或设计上的缺陷引发的安全漏洞

- #### 强制浏览

  从安置在 Web 服务器的公开目录下的文件中，浏览那些原本非自愿公开的文件。

- #### 不正确的错误消息处理

  Web 应用的错误信息或数据库等系统抛出的错误信息内包含对攻击者有用的信息。

- #### 开放重定向

  一种对指定的任意 URL 作重定向跳转的功能。假如指定的重定向 URL 到某个具有恶意的 Web 网站，那么用户就会被诱导至那个网站。

### 因会话管理疏忽引发的安全漏洞

- #### 会话劫持

  指攻击者通过某种手段拿到了用户会话 ID，并非法使用此会话ID 伪装成用户，达到攻击的目的。

- #### 会话固定攻击

  强制用户使用攻击者指定的会话 ID

- #### 跨站点请求伪造

  攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新。

### 其他安全漏洞

- #### 密码破解

  通过穷举法、字典攻击等方法算出密码，突破认证。

- #### 点击劫持

  利用透明的按钮或链接做出陷阱，覆盖在 Web 页面上。然后诱使用户在不知情的情况下，点击那个链接访问内容的一种攻击手段。

- #### Dos 攻击

  一种让运行中的服务呈停止状态的攻击

- #### 后门程序

  开发设置的隐藏入口，可不按正常步骤使用受限功能。

## 参考文献

1. 上野宣.[图解 HTTP](https://book.douban.com/subject/25863515/ "图解 HTTP"), 人民邮电出版社, 2014.

   ​
